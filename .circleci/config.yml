version: 2.1
commands:
  pre_docker_commands:
    steps:
      - checkout

      - setup_remote_docker:
          docker_layer_caching: true

      - run:
          name: "Docker login"
          command: docker login -u "$DOCKERHUB_USERNAME" -p "$DOCKERHUB_PASS"
jobs:
  deploy-dcgm-exporter-staging:
    docker:
      - image: circleci/node:4.8.2
    steps:
      - pre_docker_commands

      - run:
          name: "Docker build and push"
          command: |
            TAG=1.0.0
            docker build -t runai/dcgm-exporter-staging:$TAG -f exporters/prometheus-dcgm/dcgm-exporter/Dockerfile .
            docker push runai/dcgm-exporter-staging:$TAG

  deploy-pod-gpu-metrics-exporter-staging:
    docker:
      - image: circleci/golang:1.11
    steps:
      - pre_docker_commands

      - run:
          name: "Docker build and push"
          command: |
            TAG=1.0.0
            docker build -t runai/pod-gpu-metrics-exporter-staging:$TAG -f exporters/prometheus-dcgm/k8s/pod-gpu-metrics-exporter/Dockerfile .
            docker push runai/pod-gpu-metrics-exporter-staging:$TAG

  deploy-dcgm-exporter-production:
    docker:
      - image: circleci/node:4.8.2
    steps:
      - pre_docker_commands

      - run:
          name: "Docker build and push"
          command: |
            TAG=1.0.0
            docker build -t runai/dcgm-exporter-production:$TAG -f exporters/prometheus-dcgm/dcgm-exporter/Dockerfile .
            docker push runai/dcgm-exporter-production:$TAG

  deploy-pod-gpu-metrics-exporter-production:
    docker:
      - image: circleci/golang:1.11
    steps:
      - pre_docker_commands
      
      - run:
          name: "Docker build and push"
          command: |
            TAG=1.0.0
            docker build -t runai/pod-gpu-metrics-exporter-production:$TAG -f exporters/prometheus-dcgm/k8s/pod-gpu-metrics-exporter/Dockerfile .
            docker push runai/pod-gpu-metrics-exporter-production:$TAG
workflows:
  version: 2
  build_and_deploy:
    jobs:
      - deploy-dcgm-exporter-staging:
          filters:
            branches:
              only: master
      - deploy-pod-gpu-metrics-exporter-staging:
          filters:
            branches:
              only: master
      - deploy-dcgm-exporter-production:
          filters:
            branches:
              only: production
      - deploy-pod-gpu-metrics-exporter-production:
          filters:
            branches:
              only: production
